# Blade And Blow

## 구성요소, 버전
1. Unity: 6000.0.55f1
2. Docker: 27.5.1
3. Jenkins: 2.516.2
4. Spring Boot: 3.5.5
5. MySQL: 8.0.43
6. Redis: 7.4.5
7. MongoDB: 7.0.24

## 빌드, 배포 재현 절차

### 1. Docker 설치
```
sudo apt update && sudo apt install -y docker.io
sudo systemctl enable docker
sudo usermod -aG docker ubuntu
```
### 2. nginx 설치
```
sudo apt install -y nginx
sudo systemctl enable nginx
sudo systemctl start nginx
```
### 3. certbot 설치
```
sudo apt update
sudo apt install -y certbot python3-certbot-nginx
```
```
sudo certbot --nginx -d "도메인주소"
```
### 4. nginx 설정

#### 4.1 /etc/nginx/nginx.conf
```
http {
sendfile on;
tcp_nopush on;
tcp_nodelay on;
types_hash_max_size 2048;
server_tokens off;

include /etc/nginx/mime.types;
default_type application/octet-stream;

# 공통 프록시 헤더
proxy_http_version 1.1;
proxy_set_header Host $host;
proxy_set_header X-Real-IP $remote_addr;
proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
proxy_set_header X-Forwarded-Proto $scheme;
proxy_read_timeout 300s;
proxy_send_timeout 300s;
send_timeout 300s;

keepalive_timeout 65;
keepalive_requests 1000;

gzip on;
gzip_vary on;
gzip_comp_level 5;
gzip_types text/plain text/css application/json application/javascript text/xml application/xml application/xml+rss text/javascript image/svg+xml;
gzip_min_length 1024;

include /etc/nginx/conf.d/*.conf;
include /etc/nginx/sites-enabled/*;
}

```

#### 4.2 etc/nginx/sites-available/default
```
server {
        listen 443 ssl;
        server_name j13a405.p.ssafy.io;

        # React
        location / {
                root /var/www/react;
                index index.html;
                try_files $uri /index.html;
        }

        # API
        location /api/ {
                proxy_pass http://127.0.0.1:8081;
                proxy_read_timeout 90s;
        }

        # Jenkins
        location /ci/ {
                proxy_pass http://127.0.0.1:8080/;
                proxy_read_timeout 3600s;
                proxy_send_timeout 3600s;

                # 웹소켓 전용 헤더
                proxy_set_header Upgrade $http_upgrade;
                proxy_set_header Connection "upgrade";

                # 서브패스 인지용
                proxy_set_header X-Forwarded-Prefix /ci;
        }

        # 파일 다운로드
        location = /download/BladeAndBlow.zip {
                alias /var/www/BladeAndBlow.zip;
                types { application/zip zip; }
                add_header Content-Disposition "attachment";
        }

        # Certbot(SSL)
        ssl_certificate     /etc/letsencrypt/live/j13a405.p.ssafy.io/fullchain.pem;
        ssl_certificate_key /etc/letsencrypt/live/j13a405.p.ssafy.io/privkey.pem;
        include /etc/letsencrypt/options-ssl-nginx.conf;
        ssl_dhparam /etc/letsencrypt/ssl-dhparams.pem;
        }

# HTTP → HTTPS 단순 리다이렉트
server {
        listen 80;
        server_name j13a405.p.ssafy.io;
        return 301 https://$host$request_uri;
}

```
### 5. Jenkins 설치
```
docker run -d \
  --name jenkins \
  -p 0.0.0.0:8080:8080 \
  -p 127.0.0.1:50000:50000 \
  -e TZ=Asia/Seoul \
  -e JENKINS_OPTS="--prefix=/ci" \
  -v jenkins_home:/var/jenkins_home \
  -v /var/run/docker.sock:/var/run/docker.sock \
  --restart unless-stopped \
  jenkins/jenkins:lts
```

### 6. Jenkins 컨테이너 안에 Docker CLI + Compose v2 설치
```
docker exec -u root jenkins bash -lc '
  set -e
  apt-get update
  apt-get install -y docker.io curl
  curl -fsSL "https://github.com/docker/compose/releases/download/v2.20.2/docker-compose-$(uname -s)-$(uname -m)" \
    -o /usr/local/bin/docker-compose
  chmod +x /usr/local/bin/docker-compose
  docker --version
  /usr/local/bin/docker-compose version
'
```
### 7. Jenkins 내에 자바 설치
```
docker exec -u root jenkins bash -lc '
  apt-get update &&
  apt-get install -y openjdk-17-jdk &&
  echo "== java -version ==" && java -version &&
  echo "== JDK 17 path ==" && ls -d /usr/lib/jvm/java-17-openjdk* || true
'
```
### 8. Jenkins 초기 관리자 비밀번호 확인
```
docker exec -it jenkins cat /var/jenkins_home/secrets/initialAdminPassword
```
1. 도메인주소/ci 에서 젠킨스 아이디, 비밀번호 설정
2. plugin 에서 gitlab 설치

### 9. env 파일 만들기
```
MYSQL_ROOT_PASSWORD= 자유 문자열
MYSQL_DB=game_db
MYSQL_USER=gamedata
MYSQL_PASSWORD= 자유 문자열
JWT_SECRET= 길고 어려운 문자열
REDIS_PASSWORD= 길고 어려운 문자열
MONGODB_URI=mongodb://mongo:27017/appdb
```
### 10. 도메인/ci/manage/configureSecurity/
```
1. stack-env 이름으로 .env 파일 등록
2. gitlab access token 등록
```
### 11. jenkins pipeline
Triggers 체크하기

- ✅ Build when a change is pushed to GitLab. GitLab webhook URL ...

Pipeline 설정하기
```
  Definition : Pipeline script from SCM
    ├─ SCM : Git
    │   ├─ Repository URL : git주소
    │   ├─ Credentials : 10번에서 등록한 gitlab access token 등록
    │   └─ Branches to build : */server/master
    └─ Script Path : Jenkinsfile
```
### 12. React 파일 업로드하기
React 파일 빌드
```
경로: /GameWeb
npm i (최초에만)
npm run build
```
EC2에 업로드
```
 경로: /var/www/react
```
### 13. BladeAndBlow.zip 파일 업로드
경로: /var/www

## 네트워크/포트
```

[Client/Internet]
      │ 80/HTTPS -> 즉시 301 → 443 리다이렉트
      │ 443/HTTPS
      ▼
   [Nginx :443]
        ├─ /api/*  → 127.0.0.1:8081 → (Docker) Spring Boot
        ├─ /ci/*   → 127.0.0.1:8080 → (Docker) Jenkins
        ├─ /download/BladeAndBlow.zip → /var/www/BladeAndBlow.zip
        └─ /       → /var/www/react (SPA)
```
```
[Docker]
    │
    ├─ [Jenkins] 127.0.0.1:8080 → Jenkins:8080
    ├─ [MySQL] 127.0.0.1:3306 → mysql:3306
    ├─ [Redis] 127.0.0.1:6379 → redis:6379 
    ├─ [MongoDB] 127.0.0.1:27017 → mongo:27017 
    └─ [SpringBoot] 127.0.0.1:8081 → api:8080 
```

## DB 덤프
테이블은 JPA가 자동 생성

## 시연 시나리오
1. 다운로드
    ```
    1. 도메인 접속
    2. 다운로드 버튼 클릭
    ```
2. 게임 플레이
    ```
    1. BladeAndBlow.exe 실행
    2. Guest Login 클릭 또는 Login 페이지에서 회원가입 후 Main Menu 씬으로 이동
    3. Game Start
    4. Single Match, Team Match 중 선택
    5. alt 키를 누른 상태에서 마우스가 보이면 무기 선택후 apply 버튼 클릭
    6. 플레이어가 매칭될 때까지 대기
    ```
3. 조작법
    ```
    1. 플레이어 이동 : WASD
    2. 구르기: 좌 CTRL
    3. 달리기: 좌 SHIFT
    4. 점프: SPACE BAR
    5. 공격: 좌클릭
    ```
